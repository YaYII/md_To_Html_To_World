# 文件处理增强功能

## 概述

本扩展已集成智能文件处理机制，能够有效解决文件被占用（EBUSY错误）等常见问题，提供更好的用户体验。

## 核心功能

### 🔄 自动重试机制
- **重试次数**：最多自动重试3次
- **重试间隔**：每次重试间隔1秒
- **智能判断**：只对文件占用等可恢复错误进行重试

### 📝 自动重命名
- **备用文件名**：如果原文件被占用，自动生成备用文件名
- **命名规则**：`原文件名_1.docx`、`原文件名_2.docx`等
- **最多尝试**：最多尝试10个备用名称

### 💬 友好错误提示
- **中文提示**：提供清晰的中文错误信息
- **解决建议**：每种错误都配有具体的解决步骤
- **错误分类**：区分文件占用、权限、磁盘空间等不同问题

## 支持的错误类型

| 错误代码 | 错误描述 | 自动处理 | 用户操作建议 |
|---------|----------|----------|-------------|
| EBUSY | 文件被占用 | ✅ 重试+重命名 | 关闭占用程序 |
| EACCES | 权限不足 | ✅ 重试+重命名 | 检查文件权限 |
| EPERM | 权限错误 | ✅ 重试+重命名 | 以管理员身份运行 |
| ENOSPC | 磁盘空间不足 | ❌ | 清理磁盘空间 |
| ENAMETOOLONG | 路径过长 | ❌ | 使用更短路径 |

## 使用示例

### 正常使用
```javascript
const Converter = require('./nodejs/src/converter');

const converter = new Converter();
const result = await converter.convert_file('input.md', 'output.docx');

if (result.success) {
  console.log('转换成功:', result.outputFile);
} else {
  console.log('转换失败:', result.message);
}
```

### 文件被占用时的行为
1. **第一次尝试**：尝试写入原文件 `report.docx`
2. **检测到占用**：自动切换到备用文件名 `report_1.docx`
3. **自动重试**：如果仍然失败，继续重试或尝试 `report_2.docx`
4. **成功保存**：最终保存到可用的文件名
5. **用户通知**：告知用户实际保存的文件路径

## 配置选项

### FileHandler配置
```javascript
const fileHandler = new FileHandler({
  maxRetries: 3,        // 最大重试次数
  retryDelay: 1000,     // 重试延迟(毫秒)
  autoRename: true      // 启用自动重命名
});
```

### 禁用自动重命名
```javascript
const fileHandler = new FileHandler({
  autoRename: false     // 禁用自动重命名，失败时直接报错
});
```

## 错误处理示例

### 文件被占用错误
```
❌ 文件 "报告.docx" 正在被其他程序使用，无法保存。

💡 建议解决方案：
   1. 关闭所有打开 "报告.docx" 的程序（如Microsoft Word、WPS等）
   2. 检查是否有其他进程在使用该文件
   3. 尝试选择其他文件名或保存位置
   4. 稍等片刻后重试

🔍 错误代码: EBUSY
```

### 权限错误
```
❌ 没有权限访问文件 "报告.docx"。

💡 建议解决方案：
   1. 检查文件是否为只读状态
   2. 确保有足够的权限访问目录 "C:\Documents"
   3. 尝试以管理员身份运行VS Code
   4. 选择其他有写入权限的位置

🔍 错误代码: EACCES
```

## 最佳实践

### 1. 预防文件占用
- 转换前确保目标Word文件未被其他程序打开
- 为转换输出创建专门的文件夹
- 定期清理临时文件和旧版本文件

### 2. 处理权限问题
- 确保VS Code有足够的文件系统权限
- 避免在受保护的系统目录中进行转换
- 必要时以管理员身份运行VS Code

### 3. 磁盘空间管理
- 转换前检查磁盘可用空间
- 定期清理不需要的转换输出文件
- 考虑使用不同的磁盘分区进行转换

## 故障排除

如果遇到问题，请参考 `TROUBLESHOOTING.md` 文件获取详细的故障排除指南。

## 技术架构

### 模块组成
```
utils/
├── fileHandler.js      # 文件处理核心逻辑
├── errorHandler.js     # 错误处理和友好提示
└── configManager.js    # 配置管理

htmlToWord/
├── converter.js        # 集成了文件处理器
└── processors/         # 各种元素处理器

converter.js            # 主转换器，统一错误处理
```

### 工作流程
1. **准备阶段**：检查输入文件，初始化配置
2. **转换阶段**：Markdown → HTML → Word
3. **保存阶段**：智能文件处理，错误恢复
4. **完成阶段**：返回结果，清理资源

## 版本历史

- **v0.1.5**：添加智能文件处理机制
- **未来版本**：计划添加更多自定义配置选项

## 反馈和支持

如果您在使用过程中遇到问题或有改进建议，请通过以下方式联系：
- 查看 `TROUBLESHOOTING.md` 获取常见问题解决方案
- 记录详细的错误信息和操作步骤
- 提供系统环境信息（操作系统、VS Code版本等） 